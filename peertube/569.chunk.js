(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[569],{8169:(e,t,i)=>{"use strict";i.r(t),i.d(t,{WebTorrentPlugin:()=>A});var r=i(3654),s=i.n(r),n=i(3379),o=i(5168),a=i(327),l=i(2088),h=i(4093),u=i(6939),d=i(6553),c=i(4575),p=i(2286),y=i(2236).Buffer;class f extends d.ZP{constructor(e){super(e),this.version(1).stores({chunks:"id"})}}class m extends d.ZP{constructor(){super("webtorrent-expiration"),this.version(1).stores({databases:"name,expiration"})}}class g extends c.EventEmitter{constructor(e,t){var i;if(super(),this.pendingPut=[],this.memoryChunks={},this.databaseName="webtorrent-chunks-",t||(t={}),(null===(i=t.torrent)||void 0===i?void 0:i.infoHash)?this.databaseName+=t.torrent.infoHash:this.databaseName+="-default",this.setMaxListeners(100),this.chunkLength=Number(e),!this.chunkLength)throw new Error("First argument must be a chunk length");this.length=Number(t.length)||1/0,this.length!==1/0&&(this.lastChunkLength=this.length%this.chunkLength||this.chunkLength,this.lastChunkIndex=Math.ceil(this.length/this.chunkLength)-1),this.db=new f(this.databaseName),this.expirationDB=new m,this.runCleaner()}put(e,t,i){const r=e===this.lastChunkIndex;return r&&t.length!==this.lastChunkLength?this.nextTick(i,new Error("Last chunk length must be "+this.lastChunkLength)):r||t.length===this.chunkLength?(this.memoryChunks[e]=!0,this.pendingPut.push({id:e,buf:t,cb:i}),void(this.putBulkTimeout||(this.putBulkTimeout=setTimeout((async()=>{const e=this.pendingPut;this.pendingPut=[],this.putBulkTimeout=void 0;try{await this.db.transaction("rw",this.db.chunks,(()=>this.db.chunks.bulkPut(e.map((e=>({id:e.id,buf:e.buf}))))))}catch(t){o.k.info("Cannot bulk insert chunks. Store them in memory.",t),e.forEach((e=>{this.memoryChunks[e.id]=e.buf}))}finally{e.forEach((e=>e.cb()))}}),g.BUFFERING_PUT_MS)))):this.nextTick(i,new Error("Chunk length must be "+this.chunkLength))}get(e,t,i){if("function"==typeof t)return this.get(e,null,t);const r=this.memoryChunks[e];if(void 0===r){const e=new Error("Chunk not found");return e.notFound=!0,p.nextTick((()=>i(e)))}if(!0!==r)return i(null,r);this.db.transaction("r",this.db.chunks,(async()=>{const r=await this.db.chunks.get({id:e});if(void 0===r)return i(null,y.alloc(0));const s=r.buf;if(!t)return this.nextTick(i,null,s);const n=t.offset||0;return i(null,s.slice(n,(t.length||s.length-n)+n))})).catch((e=>(o.k.error(e),i(e))))}close(e){return this.destroy(e)}async destroy(e){try{return this.pendingPut&&(clearTimeout(this.putBulkTimeout),this.pendingPut=null),this.cleanerInterval&&(clearInterval(this.cleanerInterval),this.cleanerInterval=null),this.db&&(this.db.close(),await this.dropDatabase(this.databaseName)),this.expirationDB&&(this.expirationDB.close(),this.expirationDB=null),e()}catch(t){return o.k.error("Cannot destroy peertube chunk store.",t),e(t)}}runCleaner(){this.checkExpiration(),this.cleanerInterval=setInterval((()=>{this.checkExpiration()}),g.CLEANER_INTERVAL_MS)}async checkExpiration(){let e=[];try{await this.expirationDB.transaction("rw",this.expirationDB.databases,(async()=>{await this.expirationDB.databases.put({name:this.databaseName,expiration:(new Date).getTime()+g.CLEANER_EXPIRATION_MS});const t=(new Date).getTime();e=await this.expirationDB.databases.where("expiration").below(t).toArray()}))}catch(t){o.k.error("Cannot update expiration of fetch expired databases.",t)}for(const i of e)await this.dropDatabase(i.name)}async dropDatabase(e){const t=new f(e);o.k.info(`Destroying IndexDB database ${e}`);try{await t.delete(),await this.expirationDB.transaction("rw",this.expirationDB.databases,(()=>this.expirationDB.databases.where({name:e}).delete()))}catch(i){o.k.error(`Cannot delete ${e}.`,i)}}nextTick(e,t,i){p.nextTick((()=>e(t,i)),void 0)}}g.BUFFERING_PUT_MS=1e3,g.CLEANER_INTERVAL_MS=6e4,g.CLEANER_EXPIRATION_MS=3e5;var b=i(2776);const k=i(6832),v=i(4634),T=[".m4a",".m4v",".mp4"];function E(e,t,i,r){return function(e){if(null==e)throw new Error("file cannot be null or undefined");if("string"!=typeof e.name)throw new Error("missing or invalid file.name property");if("function"!=typeof e.createReadStream)throw new Error("missing or invalid file.createReadStream property")}(e),function(e,t,i,r){const s=(0,b.extname)(e.name).toLowerCase();let n,a,l=0;try{a=T.includes(s)?(h(),n.addEventListener("error",(function e(t){return n.removeEventListener("error",e),r(t)})),n.addEventListener("loadstart",u),new v(e,n)):function t(i=!1){const s=function(e,t=!1){const i=(0,b.extname)(e).toLowerCase();return".mp4"===i?'video/mp4; codecs="avc1.640029, mp4a.40.5"':".webm"===i?!0===t?'video/webm; codecs="vp9, opus"':'video/webm; codecs="vp8, vorbis"':void 0}(e.name,i);h(),n.addEventListener("error",(function e(i){return n.removeEventListener("error",e),s.includes("vp8")?function(e=!1){o.k.info(!0===e?"Falling back to media source with VP9 enabled.":"Falling back to media source.."),t(e)}(!0):r(i)})),n.addEventListener("loadstart",u);const a=new k(n),d=a.createWriteStream(s);return e.createReadStream().pipe(d),l&&(n.currentTime=l),a}()}catch(d){return r(d)}function h(){void 0===n&&(n=t,n.addEventListener("progress",(function(){l=t.currentTime})))}function u(){n.removeEventListener("loadstart",u),i.autoplay&&n.play(),r(null,a)}}(e,t,i,r)}const R=i(9432),w=s().getPlugin("plugin");class A extends w{constructor(e,t){super(e),this.autoplay=!1,this.startTime=0,this.CONSTANTS={INFO_SCHEDULER:1e3,AUTO_QUALITY_SCHEDULER:3e3,AUTO_QUALITY_THRESHOLD_PERCENT:30,AUTO_QUALITY_OBSERVATION_TIME:1e4,AUTO_QUALITY_HIGHER_RESOLUTION_DELAY:5e3,BANDWIDTH_AVERAGE_NUMBER_OF_VALUES:5},this.webtorrent=new n({tracker:{rtcConfig:(0,u.gI)()},dht:!1}),this.destroyingFakeRenderer=!1,this.autoResolution=!0,this.autoResolutionPossible=!0,this.isAutoResolutionObservation=!1,this.playerRefusedP2P=!1,this.downloadSpeeds=[],this.startTime=(0,l.h8)(t.startTime),this.autoplay=t.autoplay,this.playerRefusedP2P=t.playerRefusedP2P,this.videoFiles=t.videoFiles,this.videoDuration=t.videoDuration,this.savePlayerSrcFunction=this.player.src,this.playerElement=t.playerElement,this.player.ready((()=>{const e=this.player.options_,i=(0,h.OV)();void 0!==i&&this.player.volume(i);const r=void 0!==e.muted?e.muted:(0,h.W7)();void 0!==r&&this.player.muted(r),this.player.duration(t.videoDuration),this.initializePlayer(),this.runTorrentInfoScheduler(),this.player.one("play",(()=>{this.runAutoQualitySchedulerTimer=setTimeout((()=>this.runAutoQualityScheduler()),this.CONSTANTS.AUTO_QUALITY_SCHEDULER)}))}))}dispose(){clearTimeout(this.addTorrentDelay),clearTimeout(this.qualityObservationTimer),clearTimeout(this.runAutoQualitySchedulerTimer),clearInterval(this.torrentInfoInterval),clearInterval(this.autoQualityInterval),this.flushVideoFile(this.currentVideoFile,!1),this.destroyFakeRenderer()}getCurrentResolutionId(){return this.currentVideoFile?this.currentVideoFile.resolution.id:-1}updateVideoFile(e,t={},i=(()=>{})){if(!e){const t=(0,h.zZ)();e=t?this.getAppropriateFile(t):this.pickAverageVideoFile()}if(!e)throw Error("Can't update video file since videoFile is undefined.");if(void 0!==this.currentVideoFile&&this.currentVideoFile.magnetUri===e.magnetUri)return;this.player.peertube().hideFatalError(),this.player.src=()=>!0;const r=this.player.playbackRate(),s=this.currentVideoFile;if(this.currentVideoFile=e,(0,a.gn)()||this.playerRefusedP2P)return this.fallbackToHttp(t,(()=>(this.player.playbackRate(r),i())));this.addTorrent(this.currentVideoFile.magnetUri,s,t,(()=>(this.player.playbackRate(r),i()))),this.selectAppropriateResolution(!0)}updateEngineResolution(e,t=0){const i=this.player.currentTime();this.player.paused()||this.player.bigPlayButton.hide(),0===e?(this.player.addClass("vjs-playing-audio-only-content"),this.player.posterImage.show()):(this.player.removeClass("vjs-playing-audio-only-content"),this.player.posterImage.hide());const r=this.videoFiles.find((t=>t.resolution.id===e));this.updateVideoFile(r,{forcePlay:!1,delay:t,seek:i+t/1e3})}flushVideoFile(e,t=!0){void 0!==e&&this.webtorrent.get(e.magnetUri)&&(!0===t&&this.renderer&&this.renderer.destroy&&this.renderer.destroy(),this.webtorrent.remove(e.magnetUri),o.k.info(`Removed ${e.magnetUri}`))}disableAutoResolution(){this.autoResolution=!1,this.autoResolutionPossible=!1,this.player.peertubeResolutions().disableAutoResolution()}isAutoResolutionPossible(){return this.autoResolutionPossible}getTorrent(){return this.torrent}getCurrentVideoFile(){return this.currentVideoFile}changeQuality(e){-1!==e?(this.autoResolution=!1,this.updateEngineResolution(e),this.selectAppropriateResolution(!1)):!0===this.autoResolutionPossible&&(this.autoResolution=!0,this.selectAppropriateResolution(!1))}addTorrent(e,t,i,r){if(!e)return this.fallbackToHttp(i,r);o.k.info(`Adding ${e}.`);const s=this.torrent;this.torrent=this.webtorrent.add(e,{store:function(e,t){return new R(new g(e,t),{max:100})}},(n=>{o.k.info(`Added ${e}.`),s&&(this.stopTorrent(s),i.delay&&this.renderFileInFakeElement(n.files[0],i.delay)),this.addTorrentDelay=setTimeout((()=>{this.destroyFakeRenderer();const e=this.player.paused();this.flushVideoFile(t),i.seek&&this.player.currentTime(i.seek),E(n.files[0],this.playerElement,{autoplay:!1,controls:!0},((t,s)=>(this.renderer=s,t?this.fallbackToHttp(i,r):this.tryToPlay((t=>t?r(t):(i.seek&&this.seek(i.seek),!1===i.forcePlay&&!0===e&&this.player.pause(),r()))))))}),i.delay||0)})),this.torrent.on("error",(e=>o.k.error(e))),this.torrent.on("warning",(e=>{if(-1===e.message.indexOf("Unsupported tracker protocol"))if(-1===e.message.indexOf("Ice connection failed")){if(-1!==e.message.indexOf("incorrect info hash"))return o.k.error("Incorrect info hash detected, falling back to torrent file."),this.addTorrent(this.torrent.xs,t,{forcePlay:!0,seek:i.seek},r);-1!==e.message.indexOf("from xs param")&&this.handleError(e),o.k.warn(e)}else o.k.info(e)}))}tryToPlay(e){e||(e=function(){});const t=this.player.play();return void 0!==t?t.then((()=>e())).catch((t=>{if(!t.message.includes("The play() request was interrupted by a call to pause()"))return o.k.warn(t),this.player.pause(),this.player.posterImage.show(),this.player.removeClass("vjs-has-autoplay"),this.player.removeClass("vjs-has-big-play-button-clicked"),this.player.removeClass("vjs-playing-audio-only-content"),e()})):e()}seek(e){this.player.currentTime(e),this.player.handleTechSeeked_()}getAppropriateFile(e){if(void 0===this.videoFiles)return;if(1===this.videoFiles.length)return this.videoFiles[0];const t=this.videoFiles.filter((e=>0!==e.resolution.id));if(0===t.length)return;if(this.torrent&&1===this.torrent.progress&&this.player.ended())return this.currentVideoFile;e||(e=this.getAndSaveActualDownloadSpeed());const i=this.playerElement.offsetHeight;let r=t[0].resolution.id;for(let n=t.length-1;n>=0;n--){const e=t[n].resolution.id;if(0!==e&&e>=i){r=e;break}}const s=t.filter((e=>e.resolution.id<=r)).filter((t=>{const i=t.size/this.videoDuration;let r=i;return(!this.currentVideoFile||t.resolution.id>this.currentVideoFile.resolution.id)&&(r+=i*this.CONSTANTS.AUTO_QUALITY_THRESHOLD_PERCENT/100),e>r}));return 0===s.length?(0,u.FE)(t):(0,u.qx)(s)}getAndSaveActualDownloadSpeed(){const e=Math.max(this.downloadSpeeds.length-this.CONSTANTS.BANDWIDTH_AVERAGE_NUMBER_OF_VALUES,0),t=this.downloadSpeeds.slice(e,this.downloadSpeeds.length);if(0===t.length)return-1;const i=t.reduce(((e,t)=>e+t)),r=Math.round(i/t.length);return(0,h.M_)(r),r}initializePlayer(){if(this.buildQualities(),0===this.videoFiles.length)return void this.player.addClass("disabled");if(this.autoplay)return this.player.posterImage.hide(),this.updateVideoFile(void 0,{forcePlay:!0,seek:this.startTime});const e=this.player.play.bind(this.player);this.player.play=()=>{this.player.addClass("vjs-has-big-play-button-clicked"),this.player.play=e,this.updateVideoFile(void 0,{forcePlay:!0,seek:this.startTime})}}runAutoQualityScheduler(){this.autoQualityInterval=setInterval((()=>{if(null==this.torrent)return;if(!1===this.autoResolution)return;if(!0===this.isAutoResolutionObservation)return;const e=this.getAppropriateFile();let t=!1,i=0;this.isPlayerWaiting()&&e.resolution.id<this.currentVideoFile.resolution.id?(o.k.info(`Downgrading automatically the resolution to: ${e.resolution.label}`),t=!0):e.resolution.id>this.currentVideoFile.resolution.id&&(o.k.info(`Upgrading automatically the resolution to: ${e.resolution.label}`),t=!0,i=this.CONSTANTS.AUTO_QUALITY_HIGHER_RESOLUTION_DELAY),!0===t&&(this.updateEngineResolution(e.resolution.id,i),this.isAutoResolutionObservation=!0,this.qualityObservationTimer=setTimeout((()=>{this.isAutoResolutionObservation=!1}),this.CONSTANTS.AUTO_QUALITY_OBSERVATION_TIME))}),this.CONSTANTS.AUTO_QUALITY_SCHEDULER)}isPlayerWaiting(){var e;return null===(e=this.player)||void 0===e?void 0:e.hasClass("vjs-waiting")}runTorrentInfoScheduler(){this.torrentInfoInterval=setInterval((()=>{if(void 0!==this.torrent)return null===this.torrent?this.player.trigger("p2pInfo",!1):(0!==this.webtorrent.downloadSpeed&&this.downloadSpeeds.push(this.webtorrent.downloadSpeed),this.player.trigger("p2pInfo",{source:"webtorrent",http:{downloadSpeed:0,uploadSpeed:0,downloaded:0,uploaded:0},p2p:{downloadSpeed:this.torrent.downloadSpeed,numPeers:this.torrent.numPeers,uploadSpeed:this.torrent.uploadSpeed,downloaded:this.torrent.downloaded,uploaded:this.torrent.uploaded},bandwidthEstimate:this.webtorrent.downloadSpeed}))}),this.CONSTANTS.INFO_SCHEDULER)}fallbackToHttp(e,t){const i=this.player.paused();this.disableAutoResolution(),this.flushVideoFile(this.currentVideoFile,!0),this.torrent=null,this.player.one("error",(()=>this.player.peertube().displayFatalError()));const r=this.currentVideoFile.fileUrl;return this.player.src=this.savePlayerSrcFunction,this.player.src(r),this.selectAppropriateResolution(!0),this.player.trigger("sourcechange"),this.tryToPlay((r=>r&&t?t(r):(e.seek&&this.seek(e.seek),!1===e.forcePlay&&!0===i&&this.player.pause(),t?t():void 0)))}handleError(e){return this.player.trigger("customError",{err:e})}pickAverageVideoFile(){if(1===this.videoFiles.length)return this.videoFiles[0];const e=this.videoFiles.filter((e=>0!==e.resolution.id));return e[Math.floor(e.length/2)]}stopTorrent(e){e.pause(),e.removePeer(e.ws)}renderFileInFakeElement(e,t){this.destroyingFakeRenderer=!1;const i=document.createElement("video");E(e,i,{autoplay:!1,controls:!1},((e,r)=>{this.fakeRenderer=r,!1===this.destroyingFakeRenderer&&e&&o.k.error("Cannot render new torrent in fake video element.",e),i.currentTime=this.player.currentTime()+(t-2e3)}))}destroyFakeRenderer(){if(this.fakeRenderer){if(this.destroyingFakeRenderer=!0,this.fakeRenderer.destroy)try{this.fakeRenderer.destroy()}catch(e){o.k.info("Cannot destroy correctly fake renderer.",e)}this.fakeRenderer=void 0}}buildQualities(){const e=this.videoFiles.map((e=>({id:e.resolution.id,label:this.buildQualityLabel(e),height:e.resolution.id,selected:!1,selectCallback:()=>this.changeQuality(e.resolution.id)})));e.push({id:-1,label:this.player.localize("Auto"),selected:!0,selectCallback:()=>this.changeQuality(-1)}),this.player.peertubeResolutions().add(e)}buildQualityLabel(e){let t=e.resolution.label;return e.fps&&e.fps>=50&&(t+=e.fps),t}selectAppropriateResolution(e){const t=this.autoResolution?-1:this.getCurrentResolutionId(),i=this.autoResolution?this.getCurrentResolutionId():void 0;this.player.peertubeResolutions().select({id:t,autoResolutionChosenId:i,byEngine:e})}}s().registerPlugin("webtorrent",A)},2657:(e,t,i)=>{"use strict";e.exports=i(4180)},5635:(e,t,i)=>{"use strict";e.exports=i(6096)},9643:(e,t,i)=>{"use strict";i.r(t),i.d(t,{NOOP:()=>r});const r=0},5164:(e,t,i)=>{"use strict";e.exports=i(4002)},2528:()=>{},970:()=>{},1982:()=>{},1156:()=>{},1356:()=>{},2378:()=>{},2067:()=>{},6322:()=>{},4854:()=>{},9608:()=>{},8856:()=>{},5688:()=>{},7525:()=>{},7523:()=>{},146:()=>{},2050:()=>{}}]);
//# sourceMappingURL=569.chunk.js.map