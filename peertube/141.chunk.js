"use strict";(globalThis.webpackChunkpeertube_client=globalThis.webpackChunkpeertube_client||[]).push([[141],{141:(t,e,s)=>{s.r(e),s.d(e,{P2pMediaLoaderPlugin:()=>y});var i=s(3654),r=s.n(i),o=s(7382),n=s(1819),l=s(2088),a=s(4538),h=s.n(a),d=s(5168),p=s(3739);class c{constructor(t){this.hls=t,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.paused=!0,this.registerListeners()}setStreamController(t){this.streamController=t}destroy(){this.unregisterListener(),this.hls.config.capLevelToPlayerSize&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:t}=this;t.on(p.z.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.on(p.z.MEDIA_ATTACHING,this.onMediaAttaching,this),t.on(p.z.MANIFEST_PARSED,this.onManifestParsed,this),t.on(p.z.BUFFER_CODECS,this.onBufferCodecs,this),t.on(p.z.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:t}=this;t.off(p.z.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),t.off(p.z.MEDIA_ATTACHING,this.onMediaAttaching,this),t.off(p.z.MANIFEST_PARSED,this.onManifestParsed,this),t.off(p.z.BUFFER_CODECS,this.onBufferCodecs,this),t.off(p.z.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(t,e){c.isLevelAllowed(e.droppedLevel,this.restrictedLevels)&&this.restrictedLevels.push(e.droppedLevel)}onMediaAttaching(t,e){this.media=e.media instanceof HTMLVideoElement?e.media:null}onManifestParsed(t,e){const s=this.hls;this.restrictedLevels=[],this.firstLevel=e.firstLevel,s.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onBufferCodecs(t,e){this.hls.config.capLevelToPlayerSize&&e.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media&&this.mediaHeight>0&&this.mediaWidth>0){const t=this.hls.levels;if(t.length){const e=this.hls;e.autoLevelCapping=this.getMaxLevel(t.length-1),e.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=e.autoLevelCapping}}}getMaxLevel(t){const e=this.hls.levels;if(!e.length)return-1;const s=e.filter(((e,s)=>c.isLevelAllowed(s,this.restrictedLevels)&&s<=t));return this.clientRect=null,c.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}capp(){this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),this.detectPlayerSize()}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,this.hls.firstLevel=this.getMaxLevel(this.firstLevel),self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e4),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.paused&&this.clientRectLast)return this.clientRectLast;if(this.clientRect)return this.clientRect;const t=this.media,e={width:0,height:0};if(t){const s=t.getBoundingClientRect();e.width=s.width,e.height=s.height,e.width||e.height||(e.width=s.right-s.left||t.width||0,e.height=s.bottom-s.top||t.height||0)}return this.clientRectLast=this.clientRect=e,e}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let t=1;try{t=self.devicePixelRatio}catch(e){}return t>1.5&&(t=1.5),t}static isLevelAllowed(t,e=[]){return-1===e.indexOf(t)}static getMaxLevelByMediaSize(t,e,s){if(!t||!t.length)return-1;let i=t.length-1;for(let n=0;n<t.length;n+=1){const l=t[n];if((l.width>=e||l.height>=s)&&(r=l,!(o=t[n+1])||r.width!==o.width||r.height!==o.height)){i=n;break}}var r,o;return i}}const u=c;class g{constructor(t,e,s){this.errorCounts={},this.maxNetworkErrorRecovery=5,this.hlsjsConfig=null,this._duration=null,this.metadata=null,this.isLive=null,this.dvrDuration=null,this.edgeMargin=null,this.handlers={play:null},this.vjs=t,this.source=e,this.tech=s,this.tech.name_="Hlsjs",this.videoElement=s.el(),this.player=t(s.options_.playerId),this.videoElement.addEventListener("error",(t=>{let e;const s=(t.currentTarget||t.target).error;if(s){switch(d.k.info(s),s.code){case s.MEDIA_ERR_ABORTED:e="You aborted the video playback";break;case s.MEDIA_ERR_DECODE:e="The video playback was aborted due to a corruption problem or because the video used features your browser did not support",this._handleMediaError(s);break;case s.MEDIA_ERR_NETWORK:e="A network error caused the video download to fail part-way";break;case s.MEDIA_ERR_SRC_NOT_SUPPORTED:e="The video could not be loaded, either because the server or network failed or because the format is not supported";break;default:e=s.message}d.k.error(`MEDIA_ERROR: ${e}`)}})),this.initialize()}duration(){return this._duration===1/0?1/0:isNaN(this.videoElement.duration)?this._duration||0:this.videoElement.duration}seekable(){if(this.hls.media){if(!this.isLive)return this.vjs.createTimeRanges(0,this.hls.media.duration);const t=Math.round(this.hls.media.duration-this.dvrDuration),e=Math.round(this.hls.media.duration-this.edgeMargin);return this.vjs.createTimeRanges(t,e)}return this.vjs.createTimeRanges()}dispose(){this.videoElement.removeEventListener("play",this.handlers.play);const t=this.hls;t.log=t.warn=()=>{},console.log("DESTROY",this.hls),this.hls.destroy()}static addHook(t,e){g.hooks[t]=this.hooks[t]||[],g.hooks[t].push(e)}static removeHook(t,e){if(void 0===g.hooks[t])return!1;const s=g.hooks[t].indexOf(e);return-1!==s&&(g.hooks[t].splice(s,1),!0)}_executeHooksFor(t){if(void 0!==g.hooks[t])for(let e=0;e<g.hooks[t].length;e++)g.hooks[t][e](this.player,this.hls)}_handleMediaError(t){if(3==t.code){var e=this.player.currentTime()+2;return this.dispose(),this._initHlsjs(),this.player.currentTime(e),this.player.play(),void this.hls.once(h().Events.FRAG_LOADED,(()=>{this.player.play()}))}return 1===this.errorCounts[h().ErrorTypes.MEDIA_ERROR]?(d.k.info("trying to recover media error"),void this.hls.recoverMediaError()):2===this.errorCounts[h().ErrorTypes.MEDIA_ERROR]?(d.k.info("2nd try to recover media error (by swapping audio codec"),this.hls.swapAudioCodec(),void this.hls.recoverMediaError()):void(this.errorCounts[h().ErrorTypes.MEDIA_ERROR]>2&&(d.k.info("bubbling media error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>t,this.tech.trigger("error")))}_handleNetworkError(t){if(this.errorCounts[h().ErrorTypes.NETWORK_ERROR]<=this.maxNetworkErrorRecovery)return d.k.info("trying to recover network error"),setTimeout((()=>this.hls.startLoad()),1e3),void this.hls.once(h().Events.FRAG_LOADED,(()=>{this.errorCounts[h().ErrorTypes.NETWORK_ERROR]=0}));d.k.info("bubbling network error up to VIDEOJS"),this.hls.destroy(),this.tech.error=()=>t,this.tech.trigger("error")}_onError(t,e){const s={message:`HLS.js error: ${e.type} - fatal: ${e.fatal} - ${e.details}`};this.errorCounts[e.type]?this.errorCounts[e.type]+=1:this.errorCounts[e.type]=1,e.fatal?d.k.warn(s.message):d.k.error(s.message,{data:e}),e.type===h().ErrorTypes.NETWORK_ERROR?(s.code=2,this._handleNetworkError(s)):e.fatal&&e.type===h().ErrorTypes.MEDIA_ERROR&&"manifestIncompatibleCodecsError"!==e.details?(s.code=3,this._handleMediaError(s)):e.fatal&&(this.hls.destroy(),d.k.info("bubbling error up to VIDEOJS"),this.tech.error=()=>s,this.tech.trigger("error"))}buildLevelLabel(t){return this.player.srOptions_.levelLabelHandler?this.player.srOptions_.levelLabelHandler(t):t.height?t.height+"p":t.width?Math.round(9*t.width/16)+"p":t.bitrate?t.bitrate/1e3+"kbps":"0"}_notifyVideoQualities(){if(!this.metadata)return;const t=[];this.metadata.levels.forEach(((e,s)=>{t.push({id:s,height:e.height,width:e.width,bitrate:e.bitrate,label:this.buildLevelLabel(e),selected:e.id===this.hls.manualLevel,selectCallback:()=>{this.hls.currentLevel=s}})})),t.push({id:-1,label:this.player.localize("Auto"),selected:!0,selectCallback:()=>this.hls.currentLevel=-1}),this.player.peertubeResolutions().add(t)}_startLoad(){this.hls.startLoad(-1),this.videoElement.removeEventListener("play",this.handlers.play)}_oneLevelObjClone(t){const e={},s=Object.keys(t);for(let i=0;i<s.length;i++)e[s[i]]=t[s[i]];return e}_onMetaData(t,e){this.metadata=e,this._notifyVideoQualities()}_initHlsjs(){const t=this.player.srOptions_,e=(null==t?void 0:t.hlsjsConfig)||this.tech.options_.hlsjsConfig;this.hlsjsConfig=e?this._oneLevelObjClone(e):{},["","auto"].includes(this.videoElement.preload)&&!this.videoElement.autoplay&&void 0===this.hlsjsConfig.autoStartLoad&&(this.hlsjsConfig.autoStartLoad=!1),!1===this.hlsjsConfig.autoStartLoad&&(this.handlers.play=this._startLoad.bind(this),this.videoElement.addEventListener("play",this.handlers.play)),this.hlsjsConfig.capLevelController=u,this.hls=new(h())(this.hlsjsConfig),this.player.hls=this.hls,this.hls.on(h().Events.ERROR,((t,e)=>this._onError(t,e))),this.hls.on(h().Events.MANIFEST_PARSED,((t,e)=>this._onMetaData(t,e))),this.hls.on(h().Events.LEVEL_LOADED,((t,e)=>{this.hlsjsConfig.liveSyncDuration?this.edgeMargin=this.hlsjsConfig.liveSyncDuration:this.hlsjsConfig.liveSyncDurationCount&&(this.edgeMargin=this.hlsjsConfig.liveSyncDurationCount*e.details.targetduration),this.isLive=e.details.live,this.dvrDuration=e.details.totalduration,this._duration=this.isLive?1/0:e.details.totalduration,this.isLive&&(this.maxNetworkErrorRecovery=300)})),this.hls.once(h().Events.FRAG_LOADED,(()=>{this.tech.trigger("loadedmetadata")})),this.hls.on(h().Events.LEVEL_SWITCHING,((t,e)=>{const s=this.hls.autoLevelEnabled?-1:e.level,i=this.hls.autoLevelEnabled?e.level:-1;this.player.peertubeResolutions().select({id:s,autoResolutionChosenId:i,byEngine:!0})})),this.hls.attachMedia(this.videoElement),this.hls.loadSource(this.source.src)}initialize(){this._initHlsjs()}}var v;g.hooks={},((v=r()).registerPlugin||v.plugin)("hlsjs",(function(t){const e=this;t&&(e.srOptions_||(e.srOptions_={}),e.srOptions_.hlsjsConfig||(e.srOptions_.hlsjsConfig=t.hlsjsConfig),t.levelLabelHandler&&!e.srOptions_.levelLabelHandler&&(e.srOptions_.levelLabelHandler=t.levelLabelHandler))})),function(t){if(!h().isSupported())return void d.k.warn("Hls.js is not supported in this browser!");const e=t.getTech("Html5");e?(e.registerSourceHandler({canHandleSource:function(t){return/^application\/x-mpegURL|application\/vnd\.apple\.mpegurl$/i.test(t.type)?"probably":/\.m3u8/i.test(t.src)?"maybe":""},handleSource:function(e,s){return s.hlsProvider&&(console.log("HERE"),s.hlsProvider.dispose()),console.log("???ASD"),s.hlsProvider=new g(t,e,s),s.hlsProvider}},0),t.Html5Hlsjs=g):d.k.error("No Hml5 tech found in videojs")}(r());const E=r().getPlugin("plugin");class y extends E{constructor(t,e){if(super(t),this.CONSTANTS={INFO_SCHEDULER:1e3},this.statsP2PBytes={pendingDownload:[],pendingUpload:[],numPeers:0,totalDownload:0,totalUpload:0},this.statsHTTPBytes={pendingDownload:[],pendingUpload:[],totalDownload:0,totalUpload:0},this.options=e,this.options){if(r().Html5Hlsjs)(0,n.initVideoJsContribHlsJsPlayer)(t);else if(d.k.warn("HLS.js does not seem to be supported. Try to fallback to built in HLS."),!t.canPlayType("application/vnd.apple.mpegurl")){const e="Cannot fallback to built-in HLS";return d.k.warn(e),void t.ready((()=>t.trigger("error",new Error(e))))}this.startTime=(0,l.h8)(this.options.startTime),t.src({type:this.options.type,src:this.options.src}),t.ready((()=>{this.initializeCore(),this.hlsjs=t.hls,console.log("READY",t,t.hls),r().Html5Hlsjs&&this.initializePlugin()}))}}dispose(){this.hlsjs&&this.hlsjs.destroy(),this.p2pEngine&&this.p2pEngine.destroy(),clearInterval(this.networkInfoInterval)}getCurrentLevel(){return this.hlsjs.levels[this.hlsjs.currentLevel]}getLiveLatency(){return Math.round(this.hlsjs.latency)}getHLSJS(){return this.hlsjs}initializeCore(){this.player.one("play",(()=>{this.player.addClass("vjs-has-big-play-button-clicked")})),this.player.one("canplay",(()=>{this.startTime&&this.player.currentTime(this.startTime)}))}initializePlugin(){(0,n.initHlsJsPlayer)(this.hlsjs),this.p2pEngine=this.options.loader.getEngine(),this.p2pEngine.on(o.Events.SegmentError,((t,e)=>{d.k.error(`Segment ${t.id} error.`,e),this.options.redundancyUrlManager.removeBySegmentUrl(t.requestUrl)})),this.statsP2PBytes.numPeers=1+this.options.redundancyUrlManager.countBaseUrls(),this.runStats()}runStats(){this.p2pEngine.on(o.Events.PieceBytesDownloaded,((t,e,s)=>{const i="p2p"===t?this.statsP2PBytes:this.statsHTTPBytes;i.pendingDownload.push(s),i.totalDownload+=s})),this.p2pEngine.on(o.Events.PieceBytesUploaded,((t,e,s)=>{const i="p2p"===t?this.statsP2PBytes:this.statsHTTPBytes;i.pendingUpload.push(s),i.totalUpload+=s})),this.p2pEngine.on(o.Events.PeerConnect,(()=>this.statsP2PBytes.numPeers++)),this.p2pEngine.on(o.Events.PeerClose,(()=>this.statsP2PBytes.numPeers--)),this.networkInfoInterval=setInterval((()=>{const t=this.arraySum(this.statsP2PBytes.pendingDownload),e=this.arraySum(this.statsP2PBytes.pendingUpload),s=this.arraySum(this.statsHTTPBytes.pendingDownload),i=this.arraySum(this.statsHTTPBytes.pendingUpload);return this.statsP2PBytes.pendingDownload=[],this.statsP2PBytes.pendingUpload=[],this.statsHTTPBytes.pendingDownload=[],this.statsHTTPBytes.pendingUpload=[],this.player.trigger("p2pInfo",{source:"p2p-media-loader",http:{downloadSpeed:s,uploadSpeed:i,downloaded:this.statsHTTPBytes.totalDownload,uploaded:this.statsHTTPBytes.totalUpload},p2p:{downloadSpeed:t,uploadSpeed:e,numPeers:this.statsP2PBytes.numPeers,downloaded:this.statsP2PBytes.totalDownload,uploaded:this.statsP2PBytes.totalUpload},bandwidthEstimate:this.hlsjs.bandwidthEstimate/8})}),this.CONSTANTS.INFO_SCHEDULER)}arraySum(t){return t.reduce(((t,e)=>t+e),0)}}r().registerPlugin("p2pMediaLoader",y)}}]);
//# sourceMappingURL=141.chunk.js.map